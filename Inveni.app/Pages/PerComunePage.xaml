<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Inveni.App.ViewModels"
             xmlns:converters="clr-namespace:Inveni.App.ViewModels"
             xmlns:modelli="clr-namespace:Inveni.App.Modelli" 
             x:Class="Inveni.App.Pages.PerComunePage"
             x:DataType="viewmodels:PerComuneViewModel"
             Title="PER COMUNE"
             NavigationPage.HasNavigationBar="False">

    <!-- RISORSE DELLA PAGINA -->
    <ContentPage.Resources>
        <!-- Converter per mostrare elementi solo se valore > 0 -->
        <converters:MaggioreDiZeroConverter x:Key="MaggioreDiZero" />
    </ContentPage.Resources>

    <!-- REFRESH VIEW PER PULL-TO-REFRESH -->
    <RefreshView IsRefreshing="{Binding IsRefreshing}"
                 Command="{Binding CaricaComuniCommand}"
                 RefreshColor="#2196F3">

        <ScrollView>
            <VerticalStackLayout Spacing="0">

                <!-- =========================================== -->
                <!-- BARRA DI RICERCA COMUNI (FLOATING COMPATTA) -->
                <!-- =========================================== -->
                <Border BackgroundColor="White"
                    StrokeShape="RoundRectangle 20"
                    Margin="20,10,20,15"
                    Padding="0"
                    HeightRequest="40">

                    <Grid ColumnDefinitions="Auto, *, Auto" Padding="10,0">

                        <!-- ICONA LUPA -->
                        <Label Grid.Column="0"
                           Text="ðŸ”"
                           FontSize="16"
                           VerticalOptions="Center"
                           Margin="5,0,10,0" />

                        <!-- CAMPO RICERCA -->
                        <Entry Grid.Column="1"
                           Placeholder="Cerca comune..."
                           PlaceholderColor="#999999"
                           ClearButtonVisibility="WhileEditing"
                           FontSize="14"
                           BackgroundColor="Transparent"
                           VerticalOptions="Center"
                           Text="{Binding TestoRicerca, Mode=TwoWay}" />

                        <!-- PULSANTE CANCELLA (visibile solo se c'Ã¨ testo) -->
                        <Button Grid.Column="2"
                            Text="âœ•"
                            FontSize="14"
                            TextColor="#999999"
                            BackgroundColor="Transparent"
                            IsVisible="{Binding TestoRicerca, Converter={StaticResource StringToBool}}"
                            Command="{Binding MostraTuttiCommand}"
                            WidthRequest="30"
                            HeightRequest="30"
                            CornerRadius="15"
                            Padding="0"
                            Margin="5,0,0,0" />
                    </Grid>

                </Border>

                <!-- =========================================== -->
                <!-- STATO: CARICAMENTO IN CORSO -->
                <!-- =========================================== -->
                <VerticalStackLayout IsVisible="{Binding IsCaricamento}"
                                     Spacing="10"
                                     HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     Margin="0,40">

                    <!-- INDICATORE DI CARICAMENTO ROTANTE -->
                    <ActivityIndicator IsRunning="True"
                                       Color="#2196F3"
                                       HorizontalOptions="Center" />

                    <!-- MESSAGGIO DI CARICAMENTO -->
                    <Label Text="Caricamento comuni..."
                           FontSize="16"
                           TextColor="#666666"
                           HorizontalOptions="Center" />

                </VerticalStackLayout>

                <!-- =========================================== -->
                <!-- STATO: NESSUN COMUNE TROVATO -->
                <!-- =========================================== -->
                <VerticalStackLayout IsVisible="{Binding IsVuoto}"
                                     Spacing="20"
                                     HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     Margin="20">

                    <!-- ICONA COMUNE VUOTO -->
                    <Label Text="ðŸ™ï¸"
                           FontSize="40"
                           HorizontalOptions="Center"
                           TextColor="#CCCCCC" />

                    <!-- MESSAGGIO DI NESSUN RISULTATO -->
                    <Label Text="Nessun comune trovato"
                           FontSize="16"
                           TextColor="#666666"
                           HorizontalOptions="Center"
                           HorizontalTextAlignment="Center" />

                    <!-- PULSANTE PER RESETTARE LA RICERCA -->
                    <Button Text="Mostra tutti"
                            BackgroundColor="Transparent"
                            TextColor="#2196F3"
                            FontAttributes="Bold"
                            HorizontalOptions="Center"
                            Command="{Binding MostraTuttiCommand}" />

                </VerticalStackLayout>

                <!-- =========================================== -->
                <!-- STATO: ERRORE DI CARICAMENTO -->
                <!-- =========================================== -->
                <VerticalStackLayout IsVisible="{Binding IsErrore}"
                                     Spacing="20"
                                     HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     Margin="20">

                    <!-- ICONA DI ERRORE -->
                    <Label Text="âš ï¸"
                           FontSize="40"
                           HorizontalOptions="Center"
                           TextColor="#FF9800" />

                    <!-- MESSAGGIO DI ERRORE DINAMICO -->
                    <Label Text="{Binding MessaggioErrore}"
                           FontSize="16"
                           TextColor="#666666"
                           HorizontalOptions="Center"
                           HorizontalTextAlignment="Center" />

                    <!-- PULSANTE PER RIPROVARE -->
                    <Button Text="Riprova"
                            BackgroundColor="Transparent"
                            TextColor="#2196F3"
                            FontAttributes="Bold"
                            HorizontalOptions="Center"
                            Command="{Binding RiprovaCommand}" />

                </VerticalStackLayout>

                <!-- =========================================== -->
                <!-- STATO SUCCESSO: LISTA COMUNI -->
                <!-- =========================================== -->
                <CollectionView ItemsSource="{Binding ComuniFiltrati}"
                SelectionMode="None"
                IsVisible="{Binding IsSuccesso}">

                    <!-- TEMPLATE PER OGNI COMUNE -->
                    <CollectionView.ItemTemplate>
                        <DataTemplate x:DataType="modelli:ComuneRaggruppato">

                            <!-- CARD COMUNE - STILE SIMPLIFICATO -->
                            <Border StrokeShape="RoundRectangle 12"
            BackgroundColor="White"
            Stroke="{Binding ColoreBordoStato}"
            StrokeThickness="2"
            Padding="0"
            Margin="15,0,15,10">

                                <Grid RowDefinitions="160, Auto, Auto" RowSpacing="0">

                                    <!-- RIGA 0: IMMAGINE COMUNE -->
                                    <Image Grid.Row="0"
                   Source="{Binding ImmagineComune}"
                   Aspect="AspectFill"
                   HeightRequest="160" />

                                    <!-- RIGA 1: NOME COMUNE Â· X CACCE (stile GIOCA ORA) -->
                                    <HorizontalStackLayout Grid.Row="1" 
                                   Padding="15,12,15,8"
                                   Spacing="8"
                                   VerticalOptions="Center">

                                        <Label Text="{Binding NomeComune}"
                       FontSize="18"
                       FontAttributes="Bold"
                       TextColor="#1A237E"
                       LineBreakMode="TailTruncation"
                       MaxLines="1"
                       VerticalTextAlignment="Center" />

                                        <Label Text="Â·"
                       FontSize="16"
                       TextColor="#666666"
                       VerticalTextAlignment="Center" />

                                        <Label Text="{Binding TotaleCacce, StringFormat='{0} cacce'}"
                       FontSize="16"
                       TextColor="#666666"
                       VerticalTextAlignment="Center" />

                                    </HorizontalStackLayout>

                                    <!-- RIGA 2: PULSANTE VEDI CACCE (badge stile TOP) -->
                                    <Grid Grid.Row="2" Padding="15,0,15,10">
                                        <Button Text="VEDI CACCE â†’"
                                            BackgroundColor="#2196F3"
                                            TextColor="White"
                                            FontAttributes="Bold"
                                            FontSize="12"
                                            HorizontalOptions="Center"
                                            CornerRadius="20"
                                            HeightRequest="32"
                                            Padding="20,0"
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:PerComuneViewModel}}, Path=VediCacceCommand}"
                                            CommandParameter="{Binding}" />
                                    </Grid>

                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>

                </CollectionView>

            </VerticalStackLayout>
        </ScrollView>
    </RefreshView>

</ContentPage>