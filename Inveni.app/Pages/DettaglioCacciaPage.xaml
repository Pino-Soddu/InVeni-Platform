<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:Inveni.App.ViewModels"
             xmlns:modelli="clr-namespace:Inveni.App.Modelli"
             xmlns:converters="clr-namespace:Inveni.App.ViewModels"
             x:Class="Inveni.App.Pages.DettaglioCacciaPage"
             x:DataType="viewmodels:DettaglioCacciaViewModel"
             Title="{Binding Title}">

    <ContentPage.Resources>
        <converters:InverseBooleanConverter x:Key="Inverso" />
        <converters:StringToBoolConverter x:Key="NonVuoto" />
        <converters:BoolToArrowConverter x:Key="BoolToFreccia" />
        <converters:LunghezzaFormatterConverter x:Key="FormattaLunghezza" />
        <converters:MaggioreDiZeroConverter x:Key="MaggioreDiZero" />
    </ContentPage.Resources>

    <Grid>
        <!-- STATO CARICAMENTO -->
        <VerticalStackLayout IsVisible="{Binding IsCaricamento}"
                             HorizontalOptions="Center"
                             VerticalOptions="Center"
                             Spacing="20">
            <ActivityIndicator IsRunning="True" Color="#2196F3" />
            <Label Text="Caricamento caccia..." TextColor="#666666" />
        </VerticalStackLayout>

        <!-- STATO ERRORE -->
        <VerticalStackLayout IsVisible="{Binding IsErrore}"
                             HorizontalOptions="Center"
                             VerticalOptions="Center"
                             Spacing="20"
                             Padding="30">
            <Label Text="âš ï¸"
                   FontSize="48"
                   HorizontalOptions="Center" />
            <Label Text="{Binding MessaggioErrore}"
                   FontSize="16"
                   TextColor="#666666"
                   HorizontalTextAlignment="Center"
                   LineBreakMode="WordWrap" />
            <Button Text="Riprova"
                    BackgroundColor="#2196F3"
                    TextColor="White"
                    Command="{Binding RiprovaCommand}"
                    Padding="30,10"
                    CornerRadius="20" />
        </VerticalStackLayout>

        <!-- CONTENUTO PRINCIPALE -->
        <ScrollView IsVisible="{Binding IsCaricamento, Converter={StaticResource Inverso}}">
            <VerticalStackLayout Spacing="0">

                <!-- GRID CON IMMAGINE E TESTO -->
                <Grid RowDefinitions="220, Auto" RowSpacing="0">

                    <!-- RIGA 0: IMMAGINE -->
                    <Grid Grid.Row="0">
                        <BoxView Color="#000000" Opacity="0.05" />
                        <Image Source="{Binding Caccia.FotoSemplice}"
                               Aspect="AspectFill" />

                        <Border IsVisible="{Binding Caccia.IsTopCaccia}"
                                BackgroundColor="#99000000"
                                Stroke="White"
                                StrokeThickness="1"
                                StrokeShape="RoundRectangle 6"
                                Padding="8,4"
                                HorizontalOptions="End"
                                VerticalOptions="Start"
                                Margin="10">
                            <Label Text="TOP" 
                                   FontSize="12" 
                                   FontAttributes="Bold" 
                                   TextColor="White" 
                                   VerticalOptions="Center" 
                                   HorizontalOptions="Center" />
                        </Border>
                    </Grid>

                    <!-- RIGA 1: INFO TESTUALI -->
                    <VerticalStackLayout Grid.Row="1"
                                         Padding="20,15"
                                         Spacing="8"
                                         BackgroundColor="White">

                        <Label Text="{Binding TestoLuogoCompleto}"
                               FontSize="16"
                               FontAttributes="Bold"
                               TextColor="#1A237E"
                               LineBreakMode="WordWrap" />

                        <HorizontalStackLayout Spacing="5">
                            <Label Text="Realizzata da:"
                                   FontSize="14"
                                   TextColor="#666666" />
                            <Label Text="{Binding Caccia.organizzatore}"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#333333"
                                   LineBreakMode="TailTruncation" />
                        </HorizontalStackLayout>

                        <HorizontalStackLayout Spacing="5">
                            <Label Text="Stato:"
                                   FontSize="14"
                                   TextColor="#666666" />
                            <Label Text="{Binding TestoStato}"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#333333"
                               LineBreakMode="TailTruncation" />
                        </HorizontalStackLayout>

                        <HorizontalStackLayout Spacing="5">
                            <Label Text="ðŸ—“ï¸"
                                   FontSize="14"
                                   TextColor="#666666" />
                            <Label Text="Periodo:"
                                   FontSize="14"
                                   TextColor="#666666" />
                            <Label Text="{Binding PeriodoCompleto}"
                                   FontSize="14"
                                   FontAttributes="Bold"
                                   TextColor="#333333"
                                   LineBreakMode="TailTruncation" />
                        </HorizontalStackLayout>

                        <HorizontalStackLayout Spacing="15">
                            <HorizontalStackLayout Spacing="5">
                                <Label Text="ðŸš©"
                                       FontSize="14"
                                       TextColor="#666666" />
                                <Label Text="{Binding TappeFormattate}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="#333333" />
                                <Label Text="tappe"
                                       FontSize="14"
                                       TextColor="#666666" />
                            </HorizontalStackLayout>

                            <Label Text="â€¢"
                                   FontSize="14"
                                   TextColor="#CCCCCC" />

                            <HorizontalStackLayout Spacing="5">
                                <Label Text="ðŸ“"
                                       FontSize="14"
                                       TextColor="#666666" />
                                <Label Text="{Binding LunghezzaFormattata}"
                                       FontSize="14"
                                       FontAttributes="Bold"
                                       TextColor="#333333" />
                                <Label Text="(in linea d'aria)"
                                       FontSize="12"
                                       TextColor="#666666"
                                       VerticalOptions="Center" />
                            </HorizontalStackLayout>
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Grid>

                <!-- ============================================ -->
                <!-- SEZIONE 1: DESCRIZIONE/STORIA -->
                <!-- ============================================ -->
                <Border IsVisible="{Binding HaDescrizione}"
                    Margin="20,20,20,0"
                    StrokeShape="RoundRectangle 10"
                    BackgroundColor="#F8F9FA"
                    Padding="0">

                    <VerticalStackLayout Spacing="0">
                        <!-- HEADER ACCORDION (cliccabile) -->
                        <!-- HEADER ACCORDION (cliccabile) -->
                        <Grid Padding="15"
      BackgroundColor="#E8F5E9">

                            <!-- TUTTO L'HEADER Ãˆ CLICCABILE -->
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleDescrizioneCommand}" />
                            </Grid.GestureRecognizers>

                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!-- TITOLO CON ICONA -->
                            <HorizontalStackLayout Grid.Column="0"
                           Spacing="10"
                           VerticalOptions="Center">
                                <Label Text="ðŸ“–"
               FontSize="16" />
                                <Label Text="LA STORIA"
               FontSize="16"
               FontAttributes="Bold"
               TextColor="#1A237E" />
                            </HorizontalStackLayout>

                            <!-- SOLO FRECCIA -->
                            <HorizontalStackLayout Grid.Column="1"
                           Spacing="5"
                           VerticalOptions="Center">
                                <Label Text="{Binding IsDescrizioneEspansa, Converter={StaticResource BoolToFreccia}}"
                                   FontSize="14"
                                   TextColor="#666666" />
                            </HorizontalStackLayout>
                        </Grid>

                        <!-- CONTENUTO (visibile solo se espanso) -->
                        <VerticalStackLayout IsVisible="{Binding IsDescrizioneEspansa}"
                             Padding="20"
                             Spacing="10">
                            <Label Text="{Binding Caccia.text}"
                               FontSize="14"
                               TextColor="#333333"
                               LineBreakMode="WordWrap" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!-- ============================================ -->
                <!-- SEZIONE 2: PREMIO -->
                <!-- ============================================ -->
                <Border IsVisible="{Binding HaPremio}"
                    Margin="20,10,20,0"
                    StrokeShape="RoundRectangle 10"
                    BackgroundColor="#F8F9FA"
                    Padding="0">

                    <VerticalStackLayout Spacing="0">
                        <!-- HEADER ACCORDION (cliccabile) -->
                        <Grid Padding="15"
      BackgroundColor="#FFF3E0">

                            <!-- TUTTO L'HEADER Ãˆ CLICCABILE -->
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding TogglePremioCommand}" />
                            </Grid.GestureRecognizers>

                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!-- TITOLO CON ICONA -->
                            <HorizontalStackLayout Grid.Column="0"
                           Spacing="10"
                           VerticalOptions="Center">
                                <Label Text="ðŸ†"
               FontSize="16" />
                                <Label Text="IL PREMIO"
               FontSize="16"
               FontAttributes="Bold"
               TextColor="#1A237E" />
                            </HorizontalStackLayout>

                            <!-- SOLO FRECCIA -->
                            <HorizontalStackLayout Grid.Column="1"
                           Spacing="5"
                           VerticalOptions="Center">
                                <Label Text="{Binding IsPremioEspanso, Converter={StaticResource BoolToFreccia}}"
               FontSize="14"
               TextColor="#666666" />
                            </HorizontalStackLayout>
                        </Grid>

                        <!-- CONTENUTO (visibile solo se espanso) -->
                        <VerticalStackLayout IsVisible="{Binding IsPremioEspanso}"
                             Padding="20"
                             Spacing="10">
                            <Label Text="{Binding Caccia.premio}"
                   FontSize="14"
                   TextColor="#333333"
                   LineBreakMode="WordWrap" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!-- ============================================ -->
                <!-- SEZIONE 3: COME SI GIOCA -->
                <!-- ============================================ -->
                <Border IsVisible="{Binding HaRegole}"
        Margin="20,10,20,20"
        StrokeShape="RoundRectangle 10"
        BackgroundColor="#F8F9FA"
        Padding="0">

                    <VerticalStackLayout Spacing="0">
                        <!-- HEADER ACCORDION (cliccabile) -->
                        <Grid Padding="15"
      BackgroundColor="#E3F2FD">

                            <!-- TUTTO L'HEADER Ãˆ CLICCABILE -->
                            <Grid.GestureRecognizers>
                                <TapGestureRecognizer Command="{Binding ToggleRegoleCommand}" />
                            </Grid.GestureRecognizers>

                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*" />
                                <ColumnDefinition Width="Auto" />
                            </Grid.ColumnDefinitions>

                            <!-- TITOLO CON ICONA -->
                            <HorizontalStackLayout Grid.Column="0"
                           Spacing="10"
                           VerticalOptions="Center">
                                <Label Text="ðŸŽ®"
               FontSize="16" />
                                <Label Text="COME SI GIOCA"
               FontSize="16"
               FontAttributes="Bold"
               TextColor="#1A237E" />
                            </HorizontalStackLayout>

                            <!-- SOLO FRECCIA (NON BOTTONE) -->
                            <HorizontalStackLayout Grid.Column="1"
                           Spacing="5"
                           VerticalOptions="Center">
                                <Label Text="{Binding IsRegoleEspanso, Converter={StaticResource BoolToFreccia}}"
               FontSize="14"
               TextColor="#666666" />
                            </HorizontalStackLayout>
                        </Grid>

                        <!-- CONTENUTO (visibile solo se espanso) -->
                        <VerticalStackLayout IsVisible="{Binding IsRegoleEspanso}"
                             Padding="20"
                             Spacing="10">
                            <Label Text="{Binding Caccia.comesigioca}"
                   FontSize="14"
                   TextColor="#333333"
                   LineBreakMode="WordWrap" />
                        </VerticalStackLayout>
                    </VerticalStackLayout>
                </Border>

                <!-- PULSANTI SECONDARI -->
                <HorizontalStackLayout HorizontalOptions="Center"
                                       Spacing="20"
                                       Margin="0,0,0,20">
                    <Button Text="â–¶ï¸ ASCOLTA"
                            FontSize="14"
                            BackgroundColor="#E3F2FD"
                            TextColor="#2196F3"
                            Command="{Binding AscoltaCommand}"
                            Padding="20,12"
                            CornerRadius="20" />
                    <Button Text="ðŸ—ºï¸ MAPPA"
                            FontSize="14"
                            BackgroundColor="#E8F5E8"
                            TextColor="#4CAF50"
                            Command="{Binding VediMappaCommand}"
                            Padding="20,12"
                            CornerRadius="20" />
                </HorizontalStackLayout>

                <!-- PULSANTE PRIMARIO -->
                <Button Text="{Binding TestoPulsantePrimario}"
                        FontSize="16"
                        FontAttributes="Bold"
                        BackgroundColor="{Binding ColorePulsantePrimario}"
                        TextColor="White"
                        Command="{Binding AvviaCacciaCommand}"
                        Margin="20,0,20,30"
                        Padding="0,15"
                        CornerRadius="25"
                        HeightRequest="50" />

            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>